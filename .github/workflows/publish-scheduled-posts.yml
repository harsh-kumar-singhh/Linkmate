name: Publish Scheduled Posts

on:
  workflow_dispatch: # Manual trigger only
  # Scheduling is handled by an external cron service
  # GitHub Actions cron is intentionally disabled to avoid
  # minute-level precision warnings on free runners

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Publishing API
        run: |
          echo "Triggering API at $(date -u)"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://linkmate-bp2u.vercel.app/api/cron/publish" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")

          HTTP_STATUS=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response Body: $BODY"
          echo "HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "API call failed with status $HTTP_STATUS"
            exit 1
          fi